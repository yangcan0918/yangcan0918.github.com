<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>rpm包编译安装详解 | linux运维学习与交流中心</title>
  <meta name="author" content="snom">
  
  <meta name="description" content="本博客主要用来记录linux相关的文章">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="rpm包编译安装详解"/>
  <meta property="og:site_name" content="linux运维学习与交流中心"/>

  
    <meta property="og:image" content="undefined"/>
  

 <link href="/favicon.ico" rel="icon" type="image/x-ico"> 
  <link rel="alternate" href="/atom.xml" title="linux运维学习与交流中心" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">linux运维学习与交流中心</a></h1>
  <h2><a href="/">技术永无止境</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">存档</a></li>
    
      <li><a href="/about">关于</a></li>
    
      <li><a href="/todolist">ToDo</a></li>
    
      <li><a href="/Photos">Photos</a></li>
    
      <li> <a href="/atom.xml">RSS</a> </li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-11-01T07:52:04.000Z"><a href="/2014/11/01/centos制作rpm包详细过程/">11月 1 2014</a></time>
      
      
  
    <h1 class="title">rpm包编译安装详解</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="rpm包制作环境准备">rpm包制作环境准备</h2>
<h3 id="创建rpm包编译的环境及相关的目录">创建rpm包编译的环境及相关的目录</h3>
<p>在这里使用的环境是centos6.4 x86-64系统进行编译<br><a id="more"></a></p>
<h4 id="安装rpm-build包">安装rpm-build包</h4>
<pre><code>yum <span class="operator"><span class="keyword">install</span> rpm-build</span>
</code></pre><h3 id="创建目录">创建目录</h3>
<blockquote>
<p>RPM包编译需要创建几个相关的目录，软件安装后，默认情况下不会建立目录，需要另外手工建立，最好选择磁盘空间充足的位置，以备编译大的包时，磁盘空间不足而导致编译失败</p>
</blockquote>
<pre><code><span class="title">mkdir</span> /<span class="typedef"><span class="keyword">data</span>/rpmbuild/<span class="container">{<span class="type">BUILD</span>,<span class="type">RPMS</span>,<span class="type">SOURCES</span>,<span class="type">SPECS</span>,<span class="type">SRPMS</span>}</span></span>
</code></pre><h4 id="目录功能如下：">目录功能如下：</h4>
<ul>
<li>BUILD:   用于编译软件包时，源码的临时存放空间。</li>
<li>RPMS:    制作好的二进制包的输出位置。</li>
<li>SOURCES:   源码的位置。</li>
<li>SPECS:   spec文件存放的位置。</li>
<li>SRPMS:   制作好的源码RPM包的输出位置，该包安装时仍需要先编译。</li>
</ul>
<h2 id="源码包编译成rpm包(以nginx为例)">源码包编译成rpm包(以nginx为例)</h2>
<h3 id="下载源码包并放置SOURCE目录">下载源码包并放置SOURCE目录</h3>
<pre><code>wget  -P <span class="regexp">/data/</span>rpmbuild<span class="regexp">/SOURCES http:/</span><span class="regexp">/nginx.org/</span>download<span class="regexp">/nginx-1.6.2.tar.gz</span>
</code></pre><h3 id="编写spec文件">编写spec文件</h3>
<p>在SPECS目录下vim nginx.spec，默认就会生成一个spec的模板文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Name:	</div><div class="line">Version:</div><div class="line">Release:	1%{?dist}</div><div class="line">Summary:</div><div class="line">Group:</div><div class="line">License:</div><div class="line">URL:</div><div class="line">Source0:</div><div class="line">BuildRoot:	%(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)</div><div class="line">BuildRequires:</div><div class="line">Requires:</div><div class="line"><span class="tag">%<span class="title">description</span></span></div><div class="line"><span class="tag">%<span class="title">prep</span></span></div><div class="line"><span class="tag">%<span class="title">setup</span></span> -q</div><div class="line"><span class="tag">%<span class="title">build</span></span></div><div class="line"><span class="tag">%<span class="title">configure</span></span></div><div class="line">make %{?_smp_mflags}</div><div class="line"><span class="tag">%<span class="title">install</span></span></div><div class="line">rm -rf %{buildroot}</div><div class="line">make install DESTDIR=%{buildroot}</div><div class="line"><span class="tag">%<span class="title">clean</span></span></div><div class="line">rm -rf %{buildroot}</div><div class="line"><span class="tag">%<span class="title">files</span></span></div><div class="line"><span class="tag">%<span class="title">defattr</span>(-,root,root,-)</span></div><div class="line"><span class="tag">%<span class="title">doc</span></span></div><div class="line"><span class="tag">%<span class="title">changelog</span></span></div></pre></td></tr></table></figure>

<h4 id="根据我们的需求对nginx-spec文件进行添加内容">根据我们的需求对nginx.spec文件进行添加内容</h4>
<p><strong>vim nginx.spec</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#define部分定义一些常量，可选</span></div><div class="line"><span class="variable">%define</span> nginx_home /home/www</div><div class="line"><span class="variable">%define</span> nginx_user www</div><div class="line"><span class="variable">%define</span> nginx_group www</div><div class="line"><span class="variable">%define</span> _prefix /opt/app/nginx</div><div class="line"><span class="variable">%define</span> _exec_prefix <span class="variable">%{_prefix}</span></div><div class="line"><span class="variable">%define</span> _sysconfdir <span class="variable">%{_prefix}</span>/conf</div><div class="line"><span class="variable">%define</span> _localstatedir /data/logs/nginx</div><div class="line"><span class="variable">%define</span> _initrddir /etc/rc.d/init.d/</div><div class="line"><span class="comment">#设置软件包的基本信息</span></div><div class="line">Summary:  nginx is a high performance web server <span class="comment">#软件包的内容概要</span></div><div class="line">Name: nginx  <span class="comment">#软件包的名称，后面可使用%{name}的方式引用</span></div><div class="line">Version: <span class="number">1.6</span>.<span class="number">2</span>  软件的实际版本号，后面可使用<span class="variable">%{version}</span>引用</div><div class="line">Release:	<span class="number">1</span>%{?dist}  <span class="comment">#发布序列号，标明第几次打包，后面可使用%{release}引用</span></div><div class="line">URL: http:<span class="regexp">//nginx</span>.org   <span class="comment">#软件的主页</span></div><div class="line">Group: System Environment/Daemons <span class="comment"># 软件分组，建议使用标准分组</span></div><div class="line">License: GPL <span class="comment">#软件授权方式，通常就是GPL</span></div><div class="line"><span class="comment">#指定SOURCES目录中的源代码包，可以有多个，分别使用Source1、2等表示，后面可以用%{source1}、%{source2}白表示，一般默认是Source</span></div><div class="line">Source<span class="number">0</span>: nginx-<span class="number">1.6</span>.<span class="number">2</span>.tar.gz</div><div class="line">Source1: logrotate</div><div class="line">Source2: nginx_init</div><div class="line">Source3: nginx.sysconf</div><div class="line">Source4: nginx.conf</div><div class="line">Source5: default.conf</div><div class="line">Source6: nginx.vh.example_ssl.conf</div><div class="line">Source7: mime.types</div><div class="line"><span class="comment">#Patch: #补丁源码，可使用Patch1、Patch2等标识多个补丁，使用%patch0或%{patch0}引用</span></div><div class="line">BuildRoot:	<span class="variable">%{_tmppath}</span>/<span class="variable">%{name}</span>-<span class="variable">%{version}</span>-<span class="variable">%{release}</span>-root <span class="comment"># 这个是安装或编译时使用的“虚拟目录”，考虑到多用户的环境，一般定义为：</span></div><div class="line"><span class="variable">%{_tmppath}</span>/<span class="variable">%{name}</span>-<span class="variable">%{version}</span>-<span class="variable">%{release}</span>-root</div><div class="line">或</div><div class="line"><span class="variable">%{_tmppath}</span>/<span class="variable">%{name}</span>-<span class="variable">%{version}</span>-<span class="variable">%{release}</span>-buildroot-<span class="variable">%(</span><span class="variable">%{__id_u}</span> -n}该参数非常重要，因为在生成rpm的过程中，执行make install时就会把软件安装到上述的路径中，在打包的时候，同样依赖“虚拟目录”为“根目录”进行操作。后面可使用<span class="variable">$RPM_BUILD_ROOT</span>或<span class="variable">%{buildroot}</span> 方式引用。</div><div class="line">BuildRequires:	 zlib-devel, openssl-devel, make, zlib,  openssl  <span class="comment">#表示编译环境所需的依赖软件包名称</span></div><div class="line">Requires:	initscripts &gt;= <span class="number">8.36</span>,hd-luajit <span class="comment"># 该rpm包所依赖的软件包名称，可以用&gt;=或&lt;=表示大于或小于某一特定版本，例如：libpng-devel &gt;= 1.0.20 zlib ※“&gt;=”号两边需用空格隔开，而不同软件名称也用空格分开</span></div><div class="line">还有例如PreReq、Requires(pre)、Requires(post)、Requires(preun)、Requires(postun)，BuildRequires等都是针对不同阶段的依赖指定 </div><div class="line">Requires(pre): shadow-utils  <span class="comment">#表示安装前的依赖</span></div><div class="line">Requires(post): chkconfig <span class="comment">#表示安装后的依赖</span></div><div class="line">Provides: webwerver   <span class="comment">#指明本软件一些特定的功能，以便其他rpm识别</span></div><div class="line"><span class="variable">%description</span> <span class="comment">#软件的详细说明</span></div><div class="line">nginx is an http <span class="keyword">and</span> <span class="keyword">reverse</span> proxy server,as well as a mail proxy server</div><div class="line"><span class="comment">##接下来是spec脚本的主体，</span></div><div class="line"><span class="variable">%prep</span>  <span class="comment">#预处理脚本</span></div><div class="line"><span class="variable">%setup</span> -<span class="keyword">q</span> -n nginx-<span class="number">1.6</span>.<span class="number">2</span>  <span class="comment">#默认情况下，使用%setup -q,将源码包解压到BUILD目录，并进入到解压后的目录，默认解压后的文件名是%{name}-%{version},但是有时候使用的名字不同，所以有两种情况需要使用-n参数进行指定，一种是同时编译多个源码包，而是源码包的tar包的名称与解压出来的目录不一致。</span></div><div class="line">/*</div><div class="line"><span class="variable">%setup</span> 不加任何选项，仅将软件包打开。</div><div class="line"><span class="variable">%setup</span> -n newdir 将软件包解压在newdir目录。</div><div class="line"><span class="variable">%setup</span> -c 解压缩之前先产生目录。</div><div class="line"><span class="variable">%setup</span> -b num 将第num个source文件解压缩。</div><div class="line"><span class="variable">%setup</span> -T 不使用default的解压缩操作。</div><div class="line"><span class="variable">%setup</span> -T -b <span class="number">0</span> 将第<span class="number">0</span>个源代码文件解压缩。</div><div class="line"><span class="variable">%setup</span> -c -n newdir 指定目录名称newdir，并在此目录产生rpm套件。</div><div class="line"><span class="variable">%patch</span> 最简单的补丁方式，自动指定patch level。</div><div class="line"><span class="variable">%patch</span> <span class="number">0</span> 使用第<span class="number">0</span>个补丁文件，相当于<span class="variable">%patch</span> ?p <span class="number">0</span>。</div><div class="line"><span class="variable">%patch</span> -<span class="keyword">s</span> 不显示打补丁时的信息。</div><div class="line"><span class="variable">%patch</span> -T 将所有打补丁时产生的输出文件删除。</div><div class="line">*<span class="regexp">/</span></div><div class="line">#%patch 打补丁通常补丁都会一起在源码tar.gz包中，或放到SOURCES目录下。一般参数为：</div><div class="line">#%patch -p1 使用前面定义的Patch补丁进行，-p1是忽略patch的第一层目录</div><div class="line">#%Patch2 -p1 -b xxx.patch 打上指定的补丁，-b是指生成备份文件</div><div class="line">#%configure 这个不是关键字，而是rpm定义的标准宏命令。意思是执行源代码的configure配置</div><div class="line">在/usr<span class="regexp">/src/asianux</span><span class="regexp">/BUILD/</span><span class="variable">%{name}</span>-<span class="variable">%{version}</span>目录中进行 ，使用标准写法，会引用/usr/lib/rpm/marcros中定义的,下面使用的另一种不标准的写法，可参考源码中的参数自定义：</div><div class="line">./configure \</div><div class="line">--prefix=<span class="variable">%{_prefix}</span> \</div><div class="line">--user=<span class="variable">%{nginx_user}</span> \</div><div class="line">--group=<span class="variable">%{nginx_group}</span> \</div><div class="line">--with-http_stub_status_module \</div><div class="line">--with-file-aio \</div><div class="line">--with-pcre=<span class="regexp">/root/rpmbuild</span><span class="regexp">/SOURCES/pcre</span>-<span class="number">8.36</span> \</div><div class="line">--add-module=<span class="variable">$HOME</span>/rpmbuild/SOURCES/nginx_modules/ngx_devel_kit \</div><div class="line">--add-module=<span class="variable">$HOME</span>/rpmbuild/SOURCES/nginx_modules/ngx_cache_purge-<span class="number">2.1</span> \</div><div class="line">--add-module=<span class="variable">$HOME</span>/rpmbuild/SOURCES/nginx_modules/lua-nginx-module \</div><div class="line">--with-http_ssl_module \</div><div class="line">--with-http_mp4_module \</div><div class="line">--error-<span class="keyword">log</span>-path=<span class="variable">%{_localstatedir}</span>/error.<span class="keyword">log</span> \</div><div class="line">--http-<span class="keyword">log</span>-path=<span class="variable">%{_localstatedir}</span>/access.<span class="keyword">log</span> \</div><div class="line">--with-ld-opt=<span class="variable">$HOME</span>/rpmbuild/SOURCES/nginx_modules/resty_redis.o \</div><div class="line">%{?_modules}</div><div class="line"><span class="comment"># --add-module=modules/headers-more-nginx-module \</span></div><div class="line"><span class="comment"># --with-cc-opt="%{optflags}\</span></div><div class="line"><span class="comment">#开始构建包 在/usr/src/asianux/BUILD/%{name}-%{version}目录中进行make的工作</span></div><div class="line"><span class="variable">%build</span></div><div class="line">make %{?_smp_mflags}</div><div class="line"><span class="comment">#开始把软件安装到虚拟的根目录中，在/usr/src/asianux/BUILD/%{name}-%{version}目录中进行make install的操作。这个很重要，因为如果这里的路径不对的话，则下面%file中寻找文件的时候就会失败。 常见内容有：</span></div><div class="line"><span class="variable">%install</span></div><div class="line"><span class="comment">#%make install这不是关键字，而是rpm定义的标准宏命令，也可以使用非标准写法：make DESTDIR=$RPM_BUILD_ROOT install或make prefix=$RPM_BUILD_ROOT install ，更需要说明的是,这里的%install主要就是为了后面的%file服务的。所以，还可以使用常规的系统命令:install -d $RPM_BUILD_ROOT/ ,cp -a * $RPM_BUILD_ROOT/</span></div><div class="line"><span class="variable">%{__rm}</span> -rf <span class="variable">%{buildroot}</span></div><div class="line"><span class="variable">%{__make}</span> DESTDIR=<span class="variable">$RPM_BUILD_ROOT</span> install</div><div class="line"><span class="variable">%{__mkdir}</span> -p <span class="variable">%{buildroot}</span><span class="variable">%{_prefix}</span>/html</div><div class="line"><span class="variable">%{__mkdir}</span> -p <span class="variable">%{buildroot}</span><span class="variable">%{_sysconfdir}</span>/conf.d</div><div class="line"><span class="variable">%{__install}</span> -<span class="keyword">m</span> <span class="number">644</span> -p <span class="variable">%{SOURCE4}</span> <span class="variable">%{buildroot}</span><span class="variable">%{_sysconfdir}</span>/nginx.conf</div><div class="line"><span class="variable">%{__install}</span> -<span class="keyword">m</span> <span class="number">644</span> -p <span class="variable">%{SOURCE5}</span> <span class="variable">%{buildroot}</span><span class="variable">%{_sysconfdir}</span>/conf.d/0default.conf</div><div class="line"><span class="variable">%{__install}</span> -<span class="keyword">m</span> <span class="number">644</span> -p <span class="variable">%{SOURCE6}</span> <span class="variable">%{buildroot}</span><span class="variable">%{_sysconfdir}</span>/conf.d/example_ssl.conf</div><div class="line"><span class="comment"># override original mime.types</span></div><div class="line"><span class="variable">%{__install}</span> -<span class="keyword">m</span> <span class="number">644</span> -p <span class="variable">%{SOURCE7}</span> <span class="variable">%{buildroot}</span><span class="variable">%{_sysconfdir}</span>/mime.types</div><div class="line"><span class="variable">%{__install}</span> -<span class="keyword">m</span> <span class="number">644</span> -p <span class="variable">%{SOURCE3}</span> <span class="variable">%{buildroot}</span><span class="variable">%{_sysconfdir}</span>/nginx.sysconf</div><div class="line"><span class="variable">%{__mkdir}</span> -p <span class="variable">%{buildroot}</span><span class="variable">%{_initrddir}</span></div><div class="line"><span class="variable">%{__install}</span> -<span class="keyword">m</span> <span class="number">644</span> -p <span class="variable">%{SOURCE2}</span> <span class="variable">%{buildroot}</span><span class="variable">%{_initrddir}</span>nginx</div><div class="line"><span class="variable">%{__mkdir}</span> -p <span class="variable">%{buildroot}</span>/etc/logrotate.d</div><div class="line"><span class="variable">%{__install}</span> -<span class="keyword">m</span> <span class="number">644</span> -p <span class="variable">%{SOURCE1}</span> <span class="variable">%{buildroot}</span>/etc/logrotate.d/nginx</div><div class="line"><span class="variable">%{__rm}</span> -f <span class="variable">%{buildroot}</span><span class="variable">%{_sysconfdir}</span>/*.default</div><div class="line"><span class="variable">%{__chmod}</span> +<span class="keyword">x</span> <span class="variable">%{buildroot}</span><span class="variable">%{_initrddir}</span>nginx</div><div class="line"><span class="comment">#清理临时文件，注意区分$RPM_BUILD_ROOT和$RPM_BUILD_DIR：$RPM_BUILD_ROOT是指开头定义的BuildRoot，而$RPM_BUILD_DIR通常就是指BUILD，其中，前面的才是%file需要的。 </span></div><div class="line"><span class="variable">%clean</span></div><div class="line"><span class="variable">%{__rm}</span> -rf <span class="variable">%{buildroot}</span></div><div class="line"><span class="variable">%{__rm}</span> -rf <span class="variable">$RPM_BUILD_DIR</span>/<span class="variable">%{name}</span>-<span class="variable">%{version}</span></div><div class="line"><span class="comment"># 定义那些文件或目录会放入rpm中</span></div><div class="line"><span class="variable">%files</span></div><div class="line"><span class="variable">%defattr</span>(-,root,root)  <span class="comment">#指定包装文件的属性，(mode,owner,group)，-表示默认值，对文本文件是0644，可执行文件是0755</span></div><div class="line"><span class="comment">#%exclude 列出不想打包到rpm中的文件，小心，如果%exclude指定的文件不存在，也会出错的。 </span></div><div class="line"><span class="variable">%{_prefix}</span>/sbin/nginx</div><div class="line"><span class="variable">%{_sysconfdir}</span>/*</div><div class="line"><span class="variable">%{_prefix}</span>/html/*</div><div class="line"><span class="variable">%config</span>(noreplace) /etc/logrotate.d/nginx</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_initrddir}</span>/nginx</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/mime.types</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/nginx.conf</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/nginx.sysconf</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/koi-utf</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/koi-win</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/win-utf</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/scgi_params</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/uwsgi_params</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/fastcgi.conf</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/fastcgi_params</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/conf.d/0default.conf</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_sysconfdir}</span>/conf.d/example_ssl.conf</div><div class="line"><span class="variable">%config</span>(noreplace) <span class="variable">%{_prefix}</span>/html/<span class="keyword">index</span>.html</div><div class="line"><span class="comment"># rpm安装前执行的脚本</span></div><div class="line"><span class="variable">%pre</span></div><div class="line"><span class="comment"># Add the "nginx" user</span></div><div class="line">getent group <span class="variable">%{nginx_group}</span> &gt;<span class="regexp">/dev/null</span> || groupadd -g <span class="number">600</span> -r <span class="variable">%{nginx_group}</span></div><div class="line">getent passwd <span class="variable">%{nginx_user}</span> &gt;<span class="regexp">/dev/null</span> || \</div><div class="line">useradd -r -g <span class="variable">%{nginx_group}</span> -u <span class="number">600</span> -<span class="keyword">s</span> /sbin/nologin \</div><div class="line">-d <span class="variable">%{nginx_home}</span> -c <span class="string">"nginx user"</span> <span class="variable">%{nginx_user}</span></div><div class="line"><span class="comment">#  rpm安装后执行的脚本</span></div><div class="line"><span class="variable">%post</span></div><div class="line">echo <span class="string">"&lt;?php phpinfo();?&gt;"</span> &gt;<span class="variable">%{_prefix}</span>/html/<span class="keyword">index</span>.php</div><div class="line"><span class="keyword">if</span> [ ! -d <span class="variable">%{_localstatedir}</span> ]; then</div><div class="line">    <span class="variable">%{__mkdir}</span> <span class="variable">%{_localstatedir}</span></div><div class="line">fi</div><div class="line">    <span class="variable">%{__chown}</span> <span class="variable">%{nginx_user}</span>:<span class="variable">%{nginx_group}</span> <span class="variable">%{_localstatedir}</span></div><div class="line">    /sbin/chkconfig --add nginx</div><div class="line">    /sbin/chkconfig nginx on</div><div class="line"><span class="comment">#  rpm卸载前执行的脚本</span></div><div class="line"><span class="variable">%preun</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> -eq <span class="number">0</span> ]; then</div><div class="line">     /sbin/service nginx stop &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&<span class="number">1</span></div><div class="line">     /sbin/chkconfig --del nginx</div><div class="line">fi</div><div class="line"><span class="comment"># rpm卸载后执行的脚本</span></div><div class="line"><span class="variable">%postun</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> -ge <span class="number">1</span> ]; then</div><div class="line">     /sbin/service nginx upgrade &&gt;<span class="regexp">/dev/null</span> || :</div><div class="line">fi</div><div class="line"><span class="comment">#  %preun %postun 的区别是什么呢？,前者在升级的时候会执行，后者在升级rpm包的时候不会执行</span></div><div class="line"><span class="comment"># 特别需要注意的是：%install部分使用的是绝对路径，而%file部分使用则是相对路径，虽然其描述的是同一个地方。千万不要写错。</span></div><div class="line"><span class="variable">%changelog</span> <span class="comment">#更新日志</span></div></pre></td></tr></table></figure>

<h3 id="生成rpm包">生成rpm包</h3>
<p>使用rpmbuild命令生成相应的rpm包</p>
<pre><code>rpmbuild -<span class="keyword">ba</span> nginx.spec    
</code></pre><p>-ba 表示只生成rpm包<br>-bb 表示生成rpm包和src源码包</p>
<h3 id="检验包">检验包</h3>
<pre><code><span class="title">rpm</span> -qpl：列出RPM软件包内的文件信息
rpm -qpi：列出RPM软件包的描述信息
rpm -Vp： 验证RPM软件包的内容
</code></pre><h3 id="一些rpm相关知识">一些rpm相关知识</h3>
<h4 id="rpm包系统的标准分组：">rpm包系统的标准分组：</h4>
<pre><code><span class="regexp">/usr/</span>share<span class="regexp">/doc/</span>rpm-<span class="number">4.8</span>.<span class="number">0</span><span class="regexp">/GROUPS</span>
</code></pre><h4 id="各种宏定义">各种宏定义</h4>
<pre><code> <span class="regexp">/usr/</span>lib<span class="regexp">/rpm/m</span>acros
</code></pre><h4 id="已经安装的rpm包数据库">已经安装的rpm包数据库</h4>
<pre><code>/<span class="keyword">var</span>/lib/rpm
</code></pre><h4 id="如果rpm包已经做好，但在安装的时候想修改默认路径，则可以：">如果rpm包已经做好，但在安装的时候想修改默认路径，则可以：</h4>
<pre><code><span class="attribute">rpm -ivh --prefix</span>=<span class="string">/opt/usr xxx.rpm</span>
</code></pre><h4 id="又或者同时修改多个路径：">又或者同时修改多个路径：</h4>
<pre><code>rpm xxx.rpm <span class="variable">--relocate=</span>/<span class="variable">usr=</span>/opt/usr <span class="variable">--relocate=</span>/<span class="variable">etc=</span>/usr/etc 
</code></pre><h4 id="关于rpm中的执行脚本">关于rpm中的执行脚本</h4>
<blockquote>
<p>如果正在制作的rpm包是准备作为放到系统安装光盘中的话，则需要考虑rpm中定义的脚本是否有问题。由于系统在安装的时候只是依赖于一个小环境进行，而该环境与实际安装完的环境有很大的区别，所以，大部分的脚本在该安装环境中都是无法生效，甚至会带来麻烦的。所以，对于这样的，需要放到安装光盘中的套件，不加入执行脚本是较佳的方法。</p>
</blockquote>
<h4 id="rpm提供的信号机制">rpm提供的信号机制</h4>
<p>不同的操作会返回不同的信息，并放到默认变量$1中。</p>
<ul>
<li>0代表卸载</li>
<li>1代表安装</li>
<li>2代表升级</li>
</ul>
<h3 id="常用的宏变量">常用的宏变量</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="tag">%{_sysconfdir}</span>        /etc</div><div class="line"><span class="tag">%{_prefix}</span>            /usr</div><div class="line"><span class="tag">%{_exec_prefix}</span>       %{_prefix}</div><div class="line"><span class="tag">%{_bindir}</span>            %{_exec_prefix}/bin</div><div class="line"><span class="tag">%{_lib}</span>               lib (lib64 on 64bit systems)</div><div class="line"><span class="tag">%{_libdir}</span>            %{_exec_prefix}/%{_lib}</div><div class="line"><span class="tag">%{_libexecdir}</span>        %{_exec_prefix}/libexec</div><div class="line"><span class="tag">%{_sbindir}</span>           %{_exec_prefix}/sbin</div><div class="line"><span class="tag">%{_sharedstatedir}</span>    /var/lib</div><div class="line"><span class="tag">%{_datadir}</span>           %{_prefix}/share</div><div class="line"><span class="tag">%{_includedir}</span>        %{_prefix}/include</div><div class="line"><span class="tag">%{_oldincludedir}</span>     /usr/include</div><div class="line"><span class="tag">%{_infodir}</span>           /usr/share/info</div><div class="line"><span class="tag">%{_mandir}</span>            /usr/share/man</div><div class="line"><span class="tag">%{_localstatedir}</span>     /var</div><div class="line"><span class="tag">%{_initddir}</span>          %{_sysconfdir}/rc.d/init.d</div><div class="line"><span class="tag">%{_topdir}</span>            %{getenv:HOME}/rpmbuild</div><div class="line"><span class="tag">%{_builddir}</span>          %{_topdir}/BUILD</div><div class="line"><span class="tag">%{_rpmdir}</span>            %{_topdir}/RPMS</div><div class="line"><span class="tag">%{_sourcedir}</span>         %{_topdir}/SOURCES</div><div class="line"><span class="tag">%{_specdir}</span>           %{_topdir}/SPECS</div><div class="line"><span class="tag">%{_srcrpmdir}</span>         %{_topdir}/SRPMS</div><div class="line"><span class="tag">%{_buildrootdir}</span>      %{_topdir}/BUILDROOT</div><div class="line"><span class="tag">%{_global_cflags}</span>     -O2 -g -pipe</div><div class="line"><span class="tag">%{_optflags}</span>          %{__global_cflags} -m32 -march=i386 -mtune=pentium4 # if redhat-rpm-config is installed</div><div class="line"><span class="tag">%{_var}</span>               /var</div><div class="line"><span class="tag">%{_tmppath}</span>           %{_var}/tmp</div><div class="line"><span class="tag">%{_usr}</span>               /usr</div><div class="line"><span class="tag">%{_usrsrc}</span>            %{_usr}/src</div><div class="line"><span class="tag">%{_docdir}</span>            %{_datadir}/do</div></pre></td></tr></table></figure>

<h3 id="参考文档">参考文档</h3>
<ol>
<li><a href="http://www-900.ibm.com/developerWorks/cn/linux/management/package/rpm/part1/index.shtml" target="_blank" rel="external">http://www-900.ibm.com/developerWorks/cn/linux/management/package/rpm/part1/index.shtml</a></li>
<li><a href="http://www-900.ibm.com/developerWorks/cn/linux/management/package/rpm/part2/index.shtml" target="_blank" rel="external">http://www-900.ibm.com/developerWorks/cn/linux/management/package/rpm/part2/index.shtml</a></li>
<li><a href="http://www-900.ibm.com/developerWorks/cn/linux/management/package/rpm/part3/index.shtml" target="_blank" rel="external">http://www-900.ibm.com/developerWorks/cn/linux/management/package/rpm/part3/index.shtml
</a></li>
<li><a href="/usr/share/doc/rpm-4.3.2/">/usr/share/doc/rpm-4.3.2/</a></li>
<li><a href="http://www.rpm.org/RPM-HOWTO/build.html#SCRIPTS" target="_blank" rel="external">http://www.rpm.org/RPM-HOWTO/build.html#SCRIPTS</a></li>
<li><a href="http://www.linuxfans.org/nuke/modules.php?name=Forums&amp;file=printview&amp;t=86980&amp;start=0" target="_blank" rel="external">http://www.linuxfans.org/nuke/modules.php?name=Forums&amp;file=printview&amp;t=86980&amp;start=0
</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
	
<div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone"></a><a href="#" class="bds_tsina" data-cmd="tsina"></a><a href="#" class="bds_tqq" data-cmd="tqq"></a><a href="#" class="bds_renren" data-cmd="renren"></a><a href="#" class="bds_weixin" data-cmd="weixin"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdPic":"","bdStyle":"0","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



 <nav id="pagination" >
    
    <a href="/2014/11/01/curl命令常用参数的使用/" class="alignleft prev" >上一页</a>
    
    
    <a href="/2014/11/01/php使用redis做session/" class="alignright next" >下一页</a>
    
    <div class="clearfix"></div>
</nav>

<section id="comment">
<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"yangcan"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->

</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:www.yangcan.me">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/cache/">cache</a><small>1</small></li>
  
    <li><a href="/categories/docker/">docker</a><small>1</small></li>
  
    <li><a href="/categories/hexo/">hexo</a><small>1</small></li>
  
    <li><a href="/categories/mac/">mac</a><small>1</small></li>
  
    <li><a href="/categories/php/">php</a><small>2</small></li>
  
    <li><a href="/categories/命令/">命令</a><small>2</small></li>
  
    <li><a href="/categories/生活/">生活</a><small>1</small></li>
  
    <li><a href="/categories/面试题/">面试题</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/cmd/">cmd</a><small>1</small></li>
  
    <li><a href="/tags/docker/">docker</a><small>1</small></li>
  
    <li><a href="/tags/hexo/">hexo</a><small>1</small></li>
  
    <li><a href="/tags/mongo/">mongo</a><small>2</small></li>
  
    <li><a href="/tags/mysql/">mysql</a><small>1</small></li>
  
    <li><a href="/tags/nginx/">nginx</a><small>1</small></li>
  
    <li><a href="/tags/php/">php</a><small>3</small></li>
  
    <li><a href="/tags/redis/">redis</a><small>1</small></li>
  
    <li><a href="/tags/website/">website</a><small>1</small></li>
  
    <li><a href="/tags/wget/">wget</a><small>1</small></li>
  
    <li><a href="/tags/虚拟机/">虚拟机</a><small>1</small></li>
  
    <li><a href="/tags/运维/">运维</a><small>1</small></li>
  
    <li><a href="/tags/面试/">面试</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/cmd/" style="font-size: 10.00px;">cmd</a><a href="/tags/docker/" style="font-size: 10.00px;">docker</a><a href="/tags/hexo/" style="font-size: 10.00px;">hexo</a><a href="/tags/mongo/" style="font-size: 15.00px;">mongo</a><a href="/tags/mysql/" style="font-size: 10.00px;">mysql</a><a href="/tags/nginx/" style="font-size: 10.00px;">nginx</a><a href="/tags/php/" style="font-size: 20.00px;">php</a><a href="/tags/redis/" style="font-size: 10.00px;">redis</a><a href="/tags/website/" style="font-size: 10.00px;">website</a><a href="/tags/wget/" style="font-size: 10.00px;">wget</a><a href="/tags/虚拟机/" style="font-size: 10.00px;">虚拟机</a><a href="/tags/运维/" style="font-size: 10.00px;">运维</a><a href="/tags/面试/" style="font-size: 10.00px;">面试</a>
  </div>
</div>


  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=3254648682&verifier=c306487b&dpc=1"></iframe>


  <div class="widget tag">
<h3 class="title">友情链接</h3>
<ul class="entry">
<li><a href="http://zipperary.com/" title="Zippera's Blog">Zippera</a></li>
</ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 snom
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Ff501752a59d5d204ac71a701b1bd2050' type='text/javascript'%3E%3C/script%3E"));
</script>



<a href="https://github.com/you"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/8b6b8ccc6da3aa5722903da7b58eb5ab1081adee/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_orange_ff7600.png"></a>
</body>
</html>
